pipeline {
agent
    {
        node {
                label 'master'
                //customWorkspace "${env.JobPath}"
              }
    }
    stages 
    {
        stage('Start') {
            steps {
                echo 'Starting DevOps Pipeline'
            }
        }
        stage ('Code and Build') {
            steps {
                build job: 'Code and Build'
            }
        }
	stage ('Code Review') {
            steps {
                build job: 'Code Review'
            }
        }
	stage ('Unit Tests') {
            steps {
                build job: 'Unit Test'
            }
	}
        stage ('Deploy package to UiPath Orchestrator') {
            steps {
                build job: 'Deploy'
            }
        }
  	stage ('Deploy recent package & run in UiPath Orchestrator') {
            script{
                def post = new URL("https://platform.uipath.com/api/account/authenticate").openConnection();
		def message = '{"tenancyName": "Adithyan","usernameOrEmailAddress": "adithyan.mahendran@gmail.com","password": "Wipro@123"}';
		post.setRequestMethod("POST");
		post.setDoOutput(true);
		post.setRequestProperty("Content-Type", "application/json");
		post.getOutputStream().write(message.getBytes("UTF-8"));
		def postRC = post.getResponseCode();
		println(postRC);
		if(postRC.equals(200)) {
  		  def output = post.getInputStream().getText());
		  println(output);
	          def json = new groovy.json.JsonSlurper().parseText(output); 
                  def result =json.result;
                  println result
		}
            }
        }
        stage('End') {
            steps {
                echo 'Completing DevOps Pipeline'
            }
        }
    }
}